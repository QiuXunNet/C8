@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <title>首页</title>
    <link rel="stylesheet" href="/css/Chat/base.css" />
    <link rel="stylesheet" href="/css/Chat/index.css" />
</head>
<body>
    <!--页面内容-->
    <div class="layout">

        <header class="topBarBox">
            <div class="topBar">
                <a href="/Talking/Index" class="back"></a>
                <h3>
                    <p class="title">@Html.Raw(ViewBag.RommName + "聊天室")</p>
                    <div class="pepleOnlie"><span id="lineNumber">0</span>人在线</div>
                </h3>
                <div class="topMenu">
                    <a href="#">分享</a>
                    @if (ViewBag.IsAdmin == true)
                    {
                        <a href="/Talking/ManagementList/@ViewBag.RommId">管理</a>
                    }
                </div>
            </div>
        </header>
        <main class="main">
            <ul class="chat-thread" id="ChatList"></ul>
        </main>
        <footer class="footerBox">
            <div class="re_footer clearfix">
                <img src="/images/chat/icon_03.png" class="brow" style="display:none">
                <label id="chat-tuxiang" title="发送图片" for="inputImage" class="btn-default-styles">
                    <input type="file" accept="image/jpg,image/jpeg,image/png" name="file" id="inputImage" class="hidden" style="display:none">
                    <i class="iconfont icon-tuxiang"></i>
                </label>
                <img src="/images/chat/icon_06.png" class="photo">
                <div class="reply_box"> <input type="text" name="" class="reply" id="MessageContent"> </div>
                <input type="button" value="发送" class="ent" id="SendMessageBtn">
            </div>
        </footer>
    </div>
    <div id="emojiDiv" style="position:absolute;background-color:#fff;bottom:51px;left:0px;height:150px;overflow-y: scroll;display: none;">
        <ul></ul>
    </div>
    <div class="transparentBox">
        <div class="transparentBg"></div>
        <div class="big_img">
            <img id="BigImg" src="images/chat_15.png" onclick="hideBigImg()">
        </div>
    </div>
    <script src="/Scripts/jquery-1.8.0.min.js"></script>   

    <script type="text/javascript">
        $(function () {
            var winH = $(window).height();
            var winW = $(window).width();
            $('.transparentBox').height = winH

            $(".main").height(winH - 50 - 51);

            $("#emojiDiv").width(winW);

            $("#emojiDiv").css({ "padding-left": (winW % 15) + "px" });

            var lis = "";
            for (var i = 1; i <= 91; i++) {
                lis += ' <li data-index=' + i + '><img src="/images/emoji/qq/' + i + '.gif" /></li>';
            }
            $("#emojiDiv ul").append(lis);

            $(".photo").click(function () {
                if (!$("#emojiDiv").is(':visible')) {
                    $("#emojiDiv").show().scrollTop(0);
                } else {
                    $("#emojiDiv").hide();
                }

            });

            $("#emojiDiv ul li").click(function () {
                $("#emojiDiv").hide();
                var i = $(this).attr("data-index");
                var message = "[emoji_" + i + "]";
                var guid = newGuid();
                message = message;

                var obj = {};
                obj.Content = message;
                obj.UserId = userId;
                obj.UserName = userName;
                obj.PhotoImg = photoImg;
                obj.RoomId = roomId;
                obj.MsgTypeChild = 23;
                obj.Guid = guid;
                obj.IsAdmin = isAdmin;
                addMessage(obj);

                var data = {};
                data.MsgType = 2;
                data.MsgTypeChild = 23;
                data.Content = message;
                data.Guid = guid;
                var json = JSON.stringify(data);
                if (ws.readyState == WebSocket.OPEN) {
                    ws.send(json);
                }
            })
        });
    </script>

    <!-- SignalR消息推送 -->
    <script type="text/javascript">
        var ws;
        var roomId = "@ViewBag.RommId";
        var userName = "@ViewBag.UserName";
        var userId = "@ViewBag.UserId";
        var photoImg = "@ViewBag.PhotoImg";
        var isAdmin = "@ViewBag.IsAdmin";
        var isTop = false;  //历史消息是否已经到顶
        var isEverlasting = @ViewBag.IsEverlasting; //是否被拉黑

        $(function () {
            //首次加载添加聊天记录
            getChatRecord(0);
            var url = "ws://40.125.208.179:8081/Handler1.ashx?userId=" + userId +
                "&roomId=" + roomId + "&userName=" + userName + "&photoImg=" + photoImg + "&isAdmin=" + isAdmin
            ws = new WebSocket(url);

            //链接成功回调
            ws.onopen = function () {
              //  alert(0);
                //$('#msg').append('<p>已经连接</p>');
            }
            //收到消息回调
            ws.onmessage = function (evt) {
                var msg = evt.data;
                var data = eval("(" + msg+")");
                if (data == undefined || data == null)
                    return;
                switch (data.MsgTypeChild) {
                    case 11: //删除命令
                        delMessage2(data);
                        break;
                    case 12: //拉黑命令
                        blacklisted2(data);
                        break;
                    case 21: //文字消息
                    case 22: //图片消息
                    case 23: //表情包消息
                        insertMessage(data, 1)
                        $('.main').scrollTop($('.main')[0].scrollHeight);
                        setTimeout("$('.main').scrollTop($('.main')[0].scrollHeight)", 100);
                        break;
                    case 31: //心跳包
                        break;
                    case 41: //获取在线人数
                        $("#lineNumber").text(data.RoomManNum);
                        break;
                }
            }
            //链接失败回调
            ws.onerror = function (evt) {
                $('#msg').append('<p>' + JSON.stringify(evt) + '</p>');
            }
            //链接关闭回调
            ws.onclose = function () {
                $('#msg').append('<p>已经关闭</p>');
            }         

            ////加载在线人员
            //chat.client.loadMemberList = function (num) {
            //    $("#lineNumber").text(num);
            //};

            $("#SendMessageBtn").click(function () {
                sendMessage();
            });

            //滚动条滚动事件
            $(".main").bind("scroll", function () {
                var sTop = $(".main").scrollTop();
                var sTop = parseInt(sTop);
                if (sTop == 0) {
                    getChatRecord(1);
                    $(".main").scrollTop(1);
                }
            });

            if (isEverlasting == 1) {
                $("#MessageContent").attr("disabled", "disabled").val("你已经被管理员禁言");
                $(".brow").show();
                $("#chat-tuxiang").hide();
                $("#SendMessageBtn").unbind();
                $(".photo").unbind();
            }
        });

        function delMessage2(data) {
            var guid = data.Guid;
            $("#" + guid).remove();
        }

        function blacklisted2(data) {
            if (data.BlackPeople == userId) {
                $("#MessageContent").attr("disabled", "disabled").val("你已经被管理员禁言");
                $(".brow").show();
                $("#chat-tuxiang").hide();
                $("#SendMessageBtn").unbind();
                $(".photo").unbind();
                $(".deel .gray").text("已拉黑");
                isEverlasting = 1;
            }
        }

        //获取历史聊天记录
        function getChatRecord(source) {
            if (isTop == true)
                return;          
            var guid;
            if ($("#ChatList").children().length == 0) {
                guid = "";
            }
            else {
                guid = $("#ChatList").children().eq(0).attr("Id")
            }

            $.post("/Talking/GetMessageList", { roomId: roomId, guid: guid }, function (data) {
                if (data.Status == 1) {
                    if (data.DataList.length < 20)
                        isTop = true;
                    $(data.DataList).each(function () {
                        insertMessage(this, 2);
                    });
                    if (source == 0) {
                        $('.main').scrollTop($('.main')[0].scrollHeight)
                        setTimeout("$('.main').scrollTop($('.main')[0].scrollHeight)",200) ;
                    }
                }
            });
        }

        //插入聊天信息
        function insertMessage(data, insertType) { //insertType添加方式： 1:聊天  2:加载历史记录
            var html = "";

            html += "<li class='" + ((userId == data.UserId) ? "right" : "left") + " clearfix messageOption' id ='" + data.Guid + "' data-UserId='" + data.UserId +"'>";
            html += "    <img src='" + data.PhotoImg + "' class='headicon'>";
            html += "    <div class='chat_box'>";
            html += "        <div class='inform'>";
            if (data.IsAdmin) {
                html += "        <span class='adm'>管理员</span>";
            }
            html += "            <span class='nickname'>" + data.UserName + "</span>";
            html += "            <span class='time'>" + data.SendTimeStr + "</span>";
            html += "        </div>";
            switch (data.MsgTypeChild) {
                case 21:
                    html += "   <div class='chat_t'>" + data.Content + "</div>";
                    break;
                case 23:
                    var message = "/images/emoji/qq/" + data.Content.substr(7, data.Content.length - 8) + ".gif";
                    html += "    <div class='chat_t'><img src='" + message + "'></div>";
                    break;
                case 22:
                    html += "    <div class='chat_t'><img src='" + data.Content + "' onclick='showBigImg(\"" + data.Content + "\")'></div>";
                    break;
            }
            if (isAdmin == "True"){
                html += "<div class='deel'>";
                html += "   <span class='red' onclick = 'delMessage(this)'>删除</span>";
                html += "   <span class='gray' onclick = 'blacklisted(this)'>" + (isEverlasting == 1 ? "已拉黑" :"拉黑")+"</span>";
                html += "</div>";
            }
            html += "   </div>";
            html += "</li>";

            if (insertType == 1) {
                $("#ChatList").append(html);
            }
            else {
                $("#ChatList").prepend(html);
            }
        }

        //发送消息
        function sendMessage() {
            var message = $("#MessageContent").val();
            if ($.trim(message)) {
                $("#MessageContent").val("");
                var guid = newGuid();
                var message = message;

                var obj = {};
                obj.Content = message;
                obj.UserId = userId;
                obj.UserName = userName;
                obj.PhotoImg = photoImg;
                obj.RoomId = roomId;
                obj.MsgTypeChild = 21;
                obj.Guid = guid;
                obj.IsAdmin = isAdmin;
                addMessage(obj);

                var data = {};
                data.MsgType = 2;
                data.MsgTypeChild = 21;
                data.Content = message;
                data.Guid = guid;
                var json = JSON.stringify(data);
                if (ws.readyState == WebSocket.OPEN) {
                    ws.send(json);
                }
            }
        }

        //添加聊天记录到数据库
        function addMessage(data) {
            $.post("/Talking/AddMessage", data, function (data) {});
        }

        //删除聊天记录
        function delMessage(a) {
            var guid = $(a).closest(".messageOption").attr("id");
            var userId = $(a).closest(".messageOption").attr("data-UserId");
            var userName = $(a).closest(".messageOption").find(".nickname").text();

            var obj = {};
            obj.guid = guid;
            obj.userId = userId;
            obj.userName = userName;

            $.post("/Talking/DelMessage", obj, function (data) { });

            var data = {};
            data.MsgType = 1;
            data.MsgTypeChild = 11;
            data.Guid = guid;
            var json = JSON.stringify(data);
            if (ws.readyState == WebSocket.OPEN) {
                ws.send(json);
            }
        }

        //拉入黑名单
        function blacklisted(a) {
            //如果已经拉黑
            if (isEverlasting == 1) {
                return false;
            }

            var userId = $(a).closest(".messageOption").attr("data-UserId");
            var userName = $(a).closest(".messageOption").find(".nickname").text();

            var obj = {};
            obj.UserId = userId;
            obj.RoomId = roomId;
            obj.userName = userName;

            $.post("/Talking/AddBlackList", obj, function (data) { });

            var data = {};
            data.MsgType = 1;
            data.MsgTypeChild = 12;
            data.BlackPeople = userId;
            var json = JSON.stringify(data);
            if (ws.readyState == WebSocket.OPEN) {
                ws.send(json);
            }
        }

        function showBigImg(url) {
            $('.transparentBox').show()
            $("#BigImg").attr("src", url.substr(0, url.length-8)+".jpg");
        }

        function hideBigImg() {
            $('.transparentBox').hide()
        }

        function replaceAll(str) {
            for (var i = 0; i < str.length; i++) {
                str = str.replace(" ", "&nbsp;").replace(/\n|\r|(\r\n)/, "</br>");
            }
            return str;
        }

        //生成32位GUID
        function newGuid() {
            var guid = "";
            for (var i = 1; i <= 32; i++) {
                var n = Math.floor(Math.random() * 16.0).toString(16);
                guid += n;
            }
            return guid;
        }
    </script>

    <!-- 图片前端压缩处理 -->
    <script type="text/javascript">
        var eleFile = document.querySelector('#inputImage');
        // 压缩图片需要的一些元素和对象
        var reader = new FileReader(),
            //创建一个img对象
            img = new Image();

        // 选择的文件对象
        var file = null;

        // 缩放图片需要的canvas
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');

        // base64地址图片加载完毕后
        img.onload = function () {
            // 图片原始尺寸
            var originWidth = this.width;
            var originHeight = this.height;
            // 最大尺寸限制，可通过国设置宽高来实现图片压缩程度
            var maxWidth = 800,
                maxHeight = 800;
            // 目标尺寸
            var targetWidth = originWidth,
                targetHeight = originHeight;
            // 图片尺寸超过400x400的限制
            if (originWidth > maxWidth || originHeight > maxHeight) {
                if (originWidth / originHeight > maxWidth / maxHeight) {
                    // 更宽，按照宽度限定尺寸
                    targetWidth = maxWidth;
                    targetHeight = Math.round(maxWidth * (originHeight / originWidth));
                } else {
                    targetHeight = maxHeight;
                    targetWidth = Math.round(maxHeight * (originWidth / originHeight));
                }
            }
            // canvas对图片进行缩放
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            // 清除画布
            context.clearRect(0, 0, targetWidth, targetHeight);
            // 图片压缩
            context.drawImage(img, 0, 0, targetWidth, targetHeight);
            /*第一个参数是创建的img对象；第二个参数是左上角坐标，后面两个是画布区域宽高*/
            //压缩后的图片base64 url
            /*canvas.toDataURL(mimeType, qualityArgument),mimeType 默认值是'image/jpeg';
             * qualityArgument表示导出的图片质量，只要导出为jpg和webp格式的时候此参数才有效果，默认值是0.92*/
            var newUrl = canvas.toDataURL('image/jpeg', 0.92);//base64 格式
            //console.log(canvas.toDataURL('image/jpeg', 0.92));
            $.post("/Talking/SaveImg", { img: newUrl.replace("data:image/jpeg;base64,", "") }, function (data) {
                var guid = newGuid();
                var message = data ;

                var obj = {};
                obj.Content = message;
                obj.UserId = userId;
                obj.UserName = userName;
                obj.PhotoImg = photoImg;
                obj.RoomId = roomId;
                obj.MsgTypeChild = 22;
                obj.Guid = guid;
                obj.IsAdmin = isAdmin;
                addMessage(obj);

                var data2 = {};
                data2.MsgType = 2;
                data2.MsgTypeChild = 22;
                data2.Content = message;
                data2.Guid = guid;
                var json = JSON.stringify(data2);
                if (ws.readyState == WebSocket.OPEN) {
                    ws.send(json);
                }
            });
        };

        // 文件base64化，以便获知图片原始尺寸
        reader.onload = function (e) {
            img.src = e.target.result;
        };
        eleFile.addEventListener('change', function (event) {
            file = event.target.files[0];
            // 选择的文件是图片
            if (file.type.indexOf("image") == 0) {
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>